<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Lazada Loyalty Calculation</title>
    <meta name="description" content="LAZALAC: Lazada MY Awesome Loyalty Calculation">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.0.7/dist/frappe-gantt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hack/0.8.0/hack.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.4.6/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.4.6/js/tabulator.min.js"></script>
</head>    
<body class="main container" style="font-family: 'Raleway', sans-serif">
        <strong>
            <h1 class="grid">
                <span class="alert alert-success cell -12of12">Lazada Loyalty Calculation</span>            
            </h1>
        </strong>
            
        <div class="grid">            
            <div class="cell -12of12">
                    <div class="alert alert-info">
                        <h2>Features</h2>
                            <input disabled type="checkbox" checked> RM5 = 1 point<br>
                            <input disabled type="checkbox" checked> Merge more than 1 entry into 1 order<br>
                            <input disabled type="checkbox" checked> ONLY Purchase made without Coupons and SC coupons are eligible for point<br>
                            <input disabled type="checkbox" > Exclusion lists (1) Reseller (2) SKU<br>
                            <input disabled type="checkbox" > Extra points list (1) SKUs (2) Datetime/Period - First 5000..etc<br>
                    </div>
                <div class="card">                                            
                    <header class="card-header">Upload CSV here</header>
                    <div class="card-content container">             
                            <div class="inner">
                                <input type="file" id="files" name="files[]" multiple />   
                                <hr>              
                                <div id="loader-placeholder"></div>   
                                <div id="table"></div>  
                            </div>
                    </div>                           
                    <button id="downloadCsv" type="button" class="btn btn-primary btn-block">Download</button>         
                </div>
            </div>           
        </div>
    

    <script>
        var allUniqueOrders = [];
        var allUniqueOrdersWithPoints = [];
        var finalResults = [];
        var csv = [];
        document.getElementById("downloadCsv").style.visibility = "hidden";
        function sameOrderNo(currentRow, nextRow) {                           
            return currentRow[10] === nextRow[10] ? true : false                                
        }

        function getAllOrderNos(rows) {
            rows.forEach(function(row) {
                allUniqueOrders.push(row[10]);
            })
            allUniqueOrders = _.uniq(allUniqueOrders);
            allUniqueOrders.forEach(function(orderNo) {
                allUniqueOrdersWithPoints.push({
                    "orderNo": orderNo,
                    "totalPoints": 0,
                    "totalPrice": 0,
                })
            })
        }                    

        function handleFileSelect(evt) {
            $("#loader-placeholder").append('<div class="loader"></div>')   
            $("#table").remove()
            $(".inner").append('<div id="table"></div>')
            document.getElementById("downloadCsv").style.visibility = "hidden"
            var files = evt.target.files; // FileList object

            // Loop through the FileList and render image files as thumbnails.
            for (var i = 0, f; f = files[i]; i++) {
                // console.log(f);
                Papa.parse(f, {    
                    config:  {
                        delimiter: ',',
                        header: true,
                        skipEmptyLines: true,
                        worker: true,
                        fastMode: true,
                        download: false
                    },        
                    complete: function(results)
                    {
                        end = now();                                                                                                                               
                        getAllOrderNos(results.data);
                        
                        results.data.forEach(function(row) {
                            let indexToChange = _.findIndex(allUniqueOrdersWithPoints, { 'orderNo': row[10] });
                            let currentOrder = row[10]
                            let couponCode = row[4]
                            let price = +row[11]
                            let createdDate = row[7]
                            let bigPointId = row[27]
                            if (!couponCode && price > 0 && _.includes(allUniqueOrders, currentOrder)) {                                                    
                                let pointsToAdd = price / 5;                                             
                                allUniqueOrdersWithPoints[indexToChange].totalPoints += pointsToAdd 
                                allUniqueOrdersWithPoints[indexToChange].totalPrice += price                                               
                            }
                            allUniqueOrdersWithPoints[indexToChange]["totalPoints"] = _.round(allUniqueOrdersWithPoints[indexToChange].totalPoints, 2)
                            allUniqueOrdersWithPoints[indexToChange]["totalPrice"] = _.round(allUniqueOrdersWithPoints[indexToChange].totalPrice, 2)
                            allUniqueOrdersWithPoints[indexToChange]["createdDate"] = createdDate
                            allUniqueOrdersWithPoints[indexToChange]["bigPointId"] = bigPointId
                        })
                        
                        finalResults = _.filter(allUniqueOrdersWithPoints, function(allUniqueOrdersWithPoint) {
                            return allUniqueOrdersWithPoint.totalPoints > 0 
                        })                    

                        $("#table").tabulator({
                            height:450, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
                            layout:"fitDataFill", //fit columns to width of table (optional)
                            columns:[ //Define Table Columns
                                {title:"Order No", field:"orderNo",},
                                {title:"Total Points", field:"totalPoints"},
                                {title:"Total Price", field:"totalPrice"},
                                {title:"Date Created", field:"createdDate", sorter:"date", align:"center"},
                                {title:"Big Point ID", field:"bigPointId"},
                            ],
                        });

                        //load sample data into the table
                        $("#table").tabulator("setData", finalResults);
                        
                        // Download csv
                        csv = Papa.unparse(finalResults)
                        if (csv) { document.getElementById("downloadCsv").style.visibility = "visible" }
                        
                        $(".loader").remove();
                    }
                })
            }
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
        window.onload = function() {
            document.getElementById("downloadCsv").onclick = function() { 
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
                element.setAttribute('download', 'loyalty-automation-' + Date.now() + '.csv');

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            };
        };
        
        </script>  

        <style>
        .loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 0 0;            
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
</body>

</html>